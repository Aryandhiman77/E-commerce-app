<%-include('../partials/header')%>
  <%-include('../partials/navbar')%>
    <%-include('../partials/sidebar')%>
      <div class="content-wrapper" style="min-height: 1604.62px">
        <section class="content-header">
          <div class="container-fluid">
            <div class="row mb-2">
              <div class="col-sm-6">
                <h1>Products</h1>
              </div>
              <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                  <li class="breadcrumb-item"><a href="/admin">Home</a></li>
                  <li class="breadcrumb-item"><a href="/productsDetail">E-commerce</a></li>
                  <li class="breadcrumb-item active">All Products</li>
                </ol>
              </div>
            </div>
          </div>
        </section>

        <section class="content">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Products</h3>
              <div class="card-tools">
                <button type="button" class="btn btn-tool" data-card-widget="card-refresh" id="reloadData" onclick="location.reload()" data-source-selector="#card-refresh-content" data-load-on-init="false" title="refresh">
                  <i class="fas fa-sync-alt"></i>
                </button>
              </div>
            </div>
            <div class="card-body p-0">
              <table class="table table-striped projects">
                <thead>
                  <tr>
                    <th style="width: 1%">S.No</th>
                    <th style="width: 10%">Product Id</th>
                    <th style="width: 20%">Products Name</th>
                    <th style="width: 30%">Product Image</th>
                    <!-- <th>Project Progress</th> -->
                    <th style="width: 8%" class="text-center">Status</th>
                    <th style="width: 20%"></th>
                  </tr>
                </thead>
                <tbody>
                  <% if (data.length>0) { %> <% data.forEach((record,i)=> { %>
                      <tr>
                        <td>
                          <%=i+1%>
                        </td>
                        <td>
                          <%=record._id%>
                        </td>
                        <td>
                          <a>
                            <%=record.product_name%>
                          </a>
                          <br />
                          <small> Created <%=new Date(record.created_at).toLocaleDateString()+" "+new Date(record.created_at).toLocaleTimeString()%> </small>
              </td>
              <td>
                <ul class=" list-inline">
                              <li class="list-inline-item">
                                <img alt="Avatar" class="table-avatar" src="<%=record.image%>" />
                              </li>
                              </ul>
                        </td>

                        <td class="project-state">
                          <span class="badge badge-<%=record.product_status==='active'?'success':'danger'%>">
                            <%=record.product_status%>
                          </span>
                        </td>
                        <td class="project-actions text-right">
                          <button class="btn btn-primary btn-sm" value="<%=record._id%>"
                            onclick="location.href=`/<%=record._id%>`">
                            <i class="fas fa-folder"> </i>
                            View
                          </button>
                          <button data-bs-toggle="modal" data-bs-target="#Modal<%=i%>" class="d-none"
                            id="modelpopup<%=i%>"></button>
                          <button class="btn btn-info btn-sm" id="<%=record._id%>"
                            onclick="bringProductData(event,`<%=i%>`)">
                            <i class="fas fa-pencil-alt"></i>
                            Edit
                          </button>

                          <!-- Modal -->
                          <div class="modal fade" id="Modal<%=i%>" tabindex="-1" aria-labelledby="Modal<%=i%>"
                            aria-hidden="true">
                            <!-- <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true"> -->
                            <div class="modal-dialog modal-xl" style="margin: 0;">
                              <div class="modal-content" style="width: 100vw;">
                                <div class="modal-header">
                                  <h1 class="modal-title fs-5" id="<%=i%>exampleModalLabel">
                                    Update Product
                                  </h1>
                                  <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                                </div>
                                <div class="modal-body" style="width: 100vw;">
                                  <div class="row">
                                    <div class="form-group">
                                      <label for="<%=i%>product_name" class="float-left">Product Name</label>
                                      <input type="text" id="<%=i%>product_name" name="<%=i%>product_name"
                                        class="form-control" />
                                    </div>
                                    <div class="form-group">
                                      <label for="<%=i%>description" class="float-left">Product Description</label>
                                      <textarea id="<%=i%>description" name="<%=i%>description" class="form-control"
                                        rows="4"></textarea>
                                    </div>
                                   
                                    <div class="form-group">
                                      <label for="<%=i%>product_status" class="float-left">Status</label>
                                      <select id="<%=i%>product_status" class="form-control custom-select"
                                        name="<%=i%>product_status">
                                        <option>active</option>
                                        <option>inactive</option>
                                      </select>
                                    </div>
                                    <div class="form-group">
                                      <label for="<%=i%>category_name" class="float-left">Category</label>
                                      <select class="form-control custom-select" id="<%=i%>category_name"
                                        name="<%=i%>category_name">
                                        <% categories.forEach(category=> { %>
                                          <option>
                                            <%=category.category_name%>
                                          </option>
                                          <% }) %>
                                      </select>
                                    </div>
                                    <div class="form-group">
                                      <label for="<%=i%>price" class="float-left">Price</label>
                                      <input type="number" id="<%=i%>price" name="<%=i%>price" class="form-control" />
                                    </div>
                                    <div class="form-group">
                                      <label for="<%=i%>stock_quantity" class="float-left">Stock quantity</label>
                                      <input type="number" id="<%=i%>stock_quantity" name="<%=i%>stock_quantity"
                                        class="form-control" />
                                    </div>
                                    <h2 class="d-flex">Gallery</h2>
                                    <div class="productimages d-flex flex-wrap">
                                      <label for="<%=i%>inputImage1">
                                        <img class="border mx-2" width="200" height="200"
                                          src="../adminUtilities/defaultProductForm.png" id="<%=i%>previewImage1"
                                          alt="" />
                                      </label>
                                      <input type="file" id="<%=i%>inputImage1" class="d-none"
                                        name="productSingleImage" />

                                      <label for="<%=i%>inputImage2">
                                        <img class="border mx-2" width="200" height="200"
                                          src="../adminUtilities/defaultProductForm.png" id="<%=i%>previewImage2"
                                          alt="" />
                                      </label>
                                      <input type="file" id="<%=i%>inputImage2" class="d-none"
                                        name="productSingleImage" />

                                      <label for="<%=i%>inputImage3">
                                        <img class="border mx-2" width="200" height="200"
                                          src="../adminUtilities/defaultProductForm.png" id="<%=i%>previewImage3"
                                          alt="" />
                                      </label>
                                      <input type="file" id="<%=i%>inputImage3" class="d-none"
                                        name="productSingleImage" />

                                      <label for="<%=i%>inputImage4">
                                        <img class="border mx-2" width="200" height="200"
                                          src="../adminUtilities/defaultProductForm.png" id="<%=i%>previewImage4"
                                          alt="" />
                                      </label>
                                      <input type="file" id="<%=i%>inputImage4" class="d-none"
                                        name="productSingleImage" />
                                    </div>
                                  </div>
                                </div>
                                <div class="modal-footer">
                                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    Close
                                  </button>
                                  <button type="button" id="<%=i%>saveChanges" value="<%=record._id%>"
                                    onclick="handleDataUpdate(event,`<%=i%>`)" class="btn btn-primary">
                                    Save changes
                                  </button>
                                </div>
                              </div>
                            </div>
                            <!-- </div> -->
                          </div>

                          <!-- <form action="" method="delete"> -->
                          <button class="btn btn-danger btn-sm" value="<%=record._id%>"
                            onclick="deleteProduct(event,`<%=i%>`)">
                            <i class="fas fa-trash"></i>
                            Delete
                          </button>
                        </td>
                      </tr>
                      <% }) %>
                        <% } else { %>
                          <h1>no product found.</h1>
                          <% } %>
                </tbody>
              </table>
            </div>
          </div>
        </section>
      </div>


      <%-include('../partials/footer')%>
<script>
  $(document).ready(function() {
  $('#summernote').summernote();
});

const bringProductData = async (event, i) => {
          let token = document.cookie;
          const product_id = event.target.id;
          token = token.replace("token=", "");
          token = token.replace("%20", " ");

          const resp = await fetch(
            `http://localhost:8000/api/v1/product/${product_id}`,
            {
              method: "GET",
              headers: {
                authorization: token,
                "Content-Type": "application/json",
              },
            }
          );
          const data = await resp.json();
          if (data.success) {
            document.getElementById(`modelpopup${i}`).click();
            document.getElementById(`${i}product_name`).value =
              data.product.product_name;
            document.getElementById(`${i}description`).value =
              data.product.description;
            document.getElementById(`${i}category_name`).value =
              data.product.category_id.category_name;
            document.getElementById(`${i}product_status`).value =
              data.product.product_status;
            document.getElementById(`${i}stock_quantity`).value =
              data.product.stock_quantity;
            document.getElementById(`${i}price`).value =
              data.product.price;
            if (data.product.product_images.length > 0) {
              document.getElementById(`${i}previewImage1`).src = data
                .product.product_images[0]
                ? data.product.product_images[0]
                : "../adminUtilities/defaultProductForm.png";
              document.getElementById(`${i}previewImage2`).src = data
                .product.product_images[1]
                ? data.product.product_images[1]
                : "../adminUtilities/defaultProductForm.png";
              document.getElementById(`${i}previewImage3`).src = data
                .product.product_images[2]
                ? data.product.product_images[2]
                : "../adminUtilities/defaultProductForm.png";
              document.getElementById(`${i}previewImage4`).src = data
                .product.product_images[3]
                ? data.product.product_images[3]
                : "../adminUtilities/defaultProductForm.png";



              document.getElementById(`${i}category_name`).value =
                data.product.category_id.category_name;
            }
          } else {
            console.log(data);
          }
        };
        const handleDataUpdate = async (event, i) => {
          let token = document.cookie;
          token = token.replace("token=", "");
          token = token.replace("%20", " ");
          let product_name = document.getElementById(
            `${i}product_name`
          ).value;
          let description = document.getElementById(
            `${i}description`
          ).value;
          let category_name = document.getElementById(
            `${i}category_name`
          ).value;
          let product_status = document.getElementById(
            `${i}product_status`
          ).value;
          let stock_quantity = document.getElementById(
            `${i}stock_quantity`
          ).value;
          let price = document.getElementById(`${i}price`).value;
          let id = document.getElementById(`${i}saveChanges`).value;

          let img1 = document.getElementById(`${i}inputImage1`).files[0];
          let img2 = document.getElementById(`${i}inputImage2`).files[0];
          let img3 = document.getElementById(`${i}inputImage3`).files[0];
          let img4 = document.getElementById(`${i}inputImage4`).files[0];

          let images = [img1, img2, img3, img4];
          let productImages = images.filter(image => image !== undefined)
          const formdata = new FormData();
          formdata.append("product_name", product_name);
          formdata.append("description", description);
          formdata.append("category_name", category_name);
          formdata.append("product_status", product_status);
          formdata.append("stock_quantity", stock_quantity);
          formdata.append("price", price);

          if (productImages.length > 0) {
            productImages.forEach((image, i) => {
              formdata.append('productImages', image)
            })
          }

          const res = await fetch(
            `http://localhost:8000/api/v1/product/${id}`,
            {
              method: "PUT",
              headers: {
                authorization: token,
              },
              body: formdata,
            }
          );
          const Toast = Swal.mixin({
            toast: true,
            position: "top-end",
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            didOpen: (toast) => {
              toast.onmouseenter = Swal.stopTimer;
              toast.onmouseleave = Swal.resumeTimer;
            },
          });
          const result = await res.json();
          if (result.success) {
            document.getElementById(`modelpopup${i}`).click();
            document.getElementById('reloadData').classList.add('text-danger')
            document.getElementById('reloadData').classList.add('spinner-grow')
            $(document).ready(function () {
              Toast.fire({
                icon: "success",
                title: result.message,
              });
            });
          } else {
            Toast.fire({
              icon: "error",
              title: result.error,
            });
            // console.log(result)
          }
        };
        const deleteProduct = async (event, i) => {
          const swalWithBootstrapButtons = Swal.mixin({
            customClass: {
              confirmButton: "btn btn-success",
              cancelButton: "btn btn-danger"
            },
            buttonsStyling: true
          });
          swalWithBootstrapButtons.fire({
            title: "Are you sure?",
            text: "You won't be able to revert this!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Yes, delete it!",
            cancelButtonText: "No, cancel!",
            reverseButtons: true
          }).then(async(result) => {
            if (result.isConfirmed) {
              let token = document.cookie;
          token = token.replace("token=", "");
          token = token.replace("%20", " ");

          console.log('deleting', event.target.value)
          const deleteProduct = await fetch(`http://localhost:8000/api/v1/product/${event.target.value}`,{
            method:"DELETE",
            headers:{
              'Content-Type':'application/json',
              authorization:token
            }
          })
          const result = await deleteProduct.json();
          if(result.success){
            document.getElementById('reloadData').classList.add('text-danger')
            document.getElementById('reloadData').classList.add('spinner-grow')
            $(document).ready(function () {
              swalWithBootstrapButtons.fire({
                title: "Deleted!",
                text: "Your product has been deleted.",
                icon: "success"
              });
            }); 
          }
            } else if (
              result.dismiss === Swal.DismissReason.cancel
            ) {
              swalWithBootstrapButtons.fire({
                title: "Cancelled",
                text: "Your product is safe :)",
                icon: "error"
              });
            }
            else{
              console.log(result)
            Toast.fire({
              icon: "error",
              title: result.error,
            });
          }
          });
        }

</script>